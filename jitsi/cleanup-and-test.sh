#!/bin/bash

# Script de limpieza y test completo para Jitsi Meet
# Limpia contenedores obsoletos y ejecuta tests individuales usando venv

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üßπ Limpieza y Test Completo de Jitsi Meet${NC}"
echo "=================================================="

# Funci√≥n para imprimir mensajes
print_status() {
    local status="$1"
    local message="$2"
    
    case $status in
        "ERROR")
            echo -e "${RED}‚ùå ERROR:${NC} $message"
            ;;
        "WARNING")
            echo -e "${YELLOW}‚ö†Ô∏è  WARNING:${NC} $message"
            ;;
        "SUCCESS")
            echo -e "${GREEN}‚úÖ SUCCESS:${NC} $message"
            ;;
        "INFO")
            echo -e "${BLUE}‚ÑπÔ∏è  INFO:${NC} $message"
            ;;
    esac
}

# Verificar y activar entorno virtual
print_status "INFO" "Verificando entorno virtual..."

# Buscar el venv en diferentes ubicaciones posibles
VENV_PATHS=(
    "./venv"
    "../venv" 
    "./jitsi/venv"
    "../jitsi/venv"
    "./tests/venv"
)

VENV_FOUND=""
for venv_path in "${VENV_PATHS[@]}"; do
    if [ -d "$venv_path" ] && [ -f "$venv_path/bin/activate" ]; then
        VENV_FOUND="$venv_path"
        break
    fi
done

if [ -n "$VENV_FOUND" ]; then
    print_status "SUCCESS" "Entorno virtual encontrado en: $VENV_FOUND"
    print_status "INFO" "Activando entorno virtual..."
    source "$VENV_FOUND/bin/activate"
    
    # Verificar que el venv est√° activo
    if [ -n "$VIRTUAL_ENV" ]; then
        print_status "SUCCESS" "Entorno virtual activado: $VIRTUAL_ENV"
        print_status "INFO" "Python: $(python --version 2>/dev/null || echo 'No encontrado')"
        print_status "INFO" "pip: $(pip --version 2>/dev/null || echo 'No encontrado')"
        
        # Verificar dependencias cr√≠ticas
        print_status "INFO" "Verificando dependencias cr√≠ticas..."
        if python -c "import pytest" 2>/dev/null; then
            print_status "SUCCESS" "pytest disponible"
        else
            print_status "WARNING" "pytest no encontrado - instalando..."
            pip install pytest pytest-html pytest-xdist || print_status "ERROR" "No se pudo instalar pytest"
        fi
        
        if python -c "import docker" 2>/dev/null; then
            print_status "SUCCESS" "docker-py disponible"
        else
            print_status "WARNING" "docker-py no encontrado - instalando..."
            pip install docker || print_status "ERROR" "No se pudo instalar docker-py"
        fi
        
        if python -c "import requests" 2>/dev/null; then
            print_status "SUCCESS" "requests disponible"
        else
            print_status "WARNING" "requests no encontrado - instalando..."
            pip install requests || print_status "ERROR" "No se pudo instalar requests"
        fi
    else
        print_status "WARNING" "No se pudo activar el entorno virtual"
    fi
else
    print_status "WARNING" "No se encontr√≥ entorno virtual - usando Python del sistema"
    print_status "INFO" "Python del sistema: $(python3 --version 2>/dev/null || echo 'No encontrado')"
fi

# Funci√≥n para obtener el comando de Python correcto
get_python_cmd() {
    if [ -n "$VIRTUAL_ENV" ]; then
        echo "python"
    else
        echo "python3"
    fi
}

# 1. Limpiar contenedores obsoletos
print_status "INFO" "Limpiando contenedores obsoletos..."

# Detener todos los contenedores
docker compose down 2>/dev/null || true

# Eliminar contenedores obsoletos
docker container rm jitsi-meet 2>/dev/null || true
docker container rm jitsi-web 2>/dev/null || true
docker container rm jitsi-prosody 2>/dev/null || true
docker container rm jitsi-jicofo 2>/dev/null || true
docker container rm jitsi-jvb 2>/dev/null || true

print_status "SUCCESS" "Contenedores obsoletos eliminados"

# 2. Verificar configuraci√≥n
print_status "INFO" "Verificando configuraci√≥n..."

if [ ! -f ".env" ]; then
    print_status "WARNING" "Archivo .env no encontrado"
    if [ -f "env.example" ]; then
        print_status "INFO" "Copiando env.example a .env"
        cp env.example .env
    else
        print_status "ERROR" "Archivo env.example no encontrado"
        exit 1
    fi
fi

# 3. Generar contrase√±as si es necesario
print_status "INFO" "Verificando contrase√±as..."

if grep -q "JICOFO_COMPONENT_SECRET=$" .env || grep -q "JICOFO_AUTH_PASSWORD=$" .env || grep -q "JVB_AUTH_PASSWORD=$" .env; then
    print_status "WARNING" "Contrase√±as vac√≠as detectadas"
    if [ -f "gen-passwords.sh" ]; then
        print_status "INFO" "Generando contrase√±as seguras..."
        bash gen-passwords.sh
    else
        print_status "ERROR" "Script gen-passwords.sh no encontrado"
        exit 1
    fi
else
    print_status "SUCCESS" "Contrase√±as ya configuradas"
fi

# 4. Iniciar servicios
print_status "INFO" "Iniciando servicios de Jitsi Meet..."

docker compose up -d

if [ $? -eq 0 ]; then
    print_status "SUCCESS" "Servicios iniciados correctamente"
else
    print_status "ERROR" "Error al iniciar servicios"
    exit 1
fi

# 5. Esperar a que los servicios est√©n listos
print_status "INFO" "Esperando a que los servicios est√©n listos..."

sleep 10

# 6. Verificar estado de servicios antes de tests
print_status "INFO" "Verificando estado de servicios..."

echo ""
echo -e "${BLUE}üîç Verificaci√≥n de Servicios${NC}"
echo "=================================="

# Verificar contenedores
print_status "INFO" "Estado de contenedores:"
docker compose ps

echo ""
print_status "INFO" "Verificando conectividad de servicios..."

# Verificar web
if curl -s -f http://localhost:8080 > /dev/null 2>&1; then
    print_status "SUCCESS" "Web (puerto 8080) - ‚úÖ Accesible"
else
    print_status "WARNING" "Web (puerto 8080) - ‚ùå No accesible"
fi

# Verificar prosody
if curl -s -f http://localhost:5280/http-bind/ > /dev/null 2>&1; then
    print_status "SUCCESS" "Prosody (puerto 5280) - ‚úÖ Accesible"
else
    print_status "WARNING" "Prosody (puerto 5280) - ‚ùå No accesible"
fi

# Verificar puerto UDP de JVB
if netstat -tuln 2>/dev/null | grep -q ":10000"; then
    print_status "SUCCESS" "JVB (puerto 10000 UDP) - ‚úÖ Escuchando"
else
    print_status "WARNING" "JVB (puerto 10000 UDP) - ‚ùå No escuchando"
fi

echo ""

# 7. Ejecutar tests con pytest
print_status "INFO" "Ejecutando tests con pytest..."

echo ""
echo -e "${BLUE}üß™ Ejecutando Tests con pytest${NC}"
echo "=================================="

# Mostrar informaci√≥n de configuraci√≥n de tests
PYTHON_CMD=$(get_python_cmd)
print_status "INFO" "Configuraci√≥n de tests:"
echo "üìÅ Directorio de tests: $(pwd)/tests"
echo "üêç Python: $($PYTHON_CMD --version 2>/dev/null || echo 'No encontrado')"
echo "üì¶ pytest: $($PYTHON_CMD -m pytest --version 2>/dev/null || echo 'No encontrado')"
echo "üê≥ Docker: $(docker --version 2>/dev/null || echo 'No encontrado')"
if [ -n "$VIRTUAL_ENV" ]; then
    echo "üîß Entorno virtual: $VIRTUAL_ENV"
fi

echo ""
print_status "INFO" "Ejecutando tests individuales con informaci√≥n detallada..."

# Ejecutar tests con informaci√≥n detallada
if $PYTHON_CMD -m pytest tests/ -v --tb=short --durations=10; then
    print_status "SUCCESS" "Todos los tests pasaron exitosamente"
    TEST_RESULT="SUCCESS"
else
    print_status "WARNING" "Algunos tests fallaron - revisando detalles..."
    TEST_RESULT="FAILED"
    
    echo ""
    print_status "INFO" "Ejecutando tests espec√≠ficos para diagn√≥stico..."
    
    # Tests espec√≠ficos para diagn√≥stico
    echo ""
    echo -e "${YELLOW}üîç Diagn√≥stico de Tests Espec√≠ficos${NC}"
    echo "=================================="
    
    # Test de contenedores
    print_status "INFO" "Verificando tests de contenedores..."
    $PYTHON_CMD -m pytest tests/test_jicofo.py::test_jicofo_container_running -v -s || true
    $PYTHON_CMD -m pytest tests/test_jvb.py::test_jvb_container_running -v -s || true
    $PYTHON_CMD -m pytest tests/test_prosody.py::test_prosody_container_running -v -s || true
    $PYTHON_CMD -m pytest tests/test_web.py::test_web_container_running -v -s || true
    
    # Test de procesos
    print_status "INFO" "Verificando tests de procesos..."
    $PYTHON_CMD -m pytest tests/test_jicofo.py::test_jicofo_process_running -v -s || true
    $PYTHON_CMD -m pytest tests/test_jvb.py::test_jvb_process_running -v -s || true
    $PYTHON_CMD -m pytest tests/test_prosody.py::test_prosody_xmpp_connection -v -s || true
    $PYTHON_CMD -m pytest tests/test_web.py::test_web_nginx_process -v -s || true
    
    # Test de configuraci√≥n
    print_status "INFO" "Verificando tests de configuraci√≥n..."
    $PYTHON_CMD -m pytest tests/test_prosody.py::test_prosody_configuration_files -v -s || true
fi

# 8. Resumen final con informaci√≥n detallada
echo ""
echo "=================================================="
echo -e "${BLUE}üìä RESUMEN FINAL${NC}"
echo "=================================================="

# Mostrar resultado de tests
echo ""
if [ "$TEST_RESULT" = "SUCCESS" ]; then
    print_status "SUCCESS" "‚úÖ TODOS LOS TESTS PASARON EXITOSAMENTE"
    echo -e "${GREEN}üéâ ¬°Jitsi Meet est√° funcionando correctamente!${NC}"
else
    print_status "WARNING" "‚ö†Ô∏è  ALGUNOS TESTS FALLARON - Revisar detalles arriba"
    echo -e "${YELLOW}üîß Se recomienda revisar la configuraci√≥n${NC}"
fi

# Verificar estado de contenedores
echo ""
echo -e "${BLUE}üìã Estado de contenedores:${NC}"
docker compose ps

# Mostrar informaci√≥n de salud de contenedores
echo ""
echo -e "${BLUE}üè• Salud de contenedores:${NC}"
for container in jitsi-web jitsi-prosody jitsi-jicofo jitsi-jvb; do
    if docker ps --format "table {{.Names}}\t{{.Status}}" | grep -q "$container"; then
        status=$(docker ps --format "{{.Status}}" --filter "name=$container")
        if echo "$status" | grep -q "healthy\|Up"; then
            print_status "SUCCESS" "$container: $status"
        else
            print_status "WARNING" "$container: $status"
        fi
    else
        print_status "ERROR" "$container: No est√° ejecut√°ndose"
    fi
done

# Mostrar logs recientes si hay problemas
if [ "$TEST_RESULT" = "FAILED" ]; then
    echo ""
    echo -e "${YELLOW}üìã Logs recientes de contenedores (√∫ltimas 5 l√≠neas):${NC}"
    for container in jitsi-web jitsi-prosody jitsi-jicofo jitsi-jvb; do
        if docker ps --format "{{.Names}}" | grep -q "$container"; then
            echo ""
            echo -e "${BLUE}üìÑ Logs de $container:${NC}"
            docker logs --tail=5 "$container" 2>/dev/null || echo "No se pudieron obtener logs"
        fi
    done
fi

echo ""
echo -e "${BLUE}üåê Informaci√≥n de acceso:${NC}"
echo "   üè† URL principal: http://localhost:8080"
echo "   üéØ Crear sala: http://localhost:8080/mi-sala"
echo "   üìä BOSH endpoint: http://localhost:5280/http-bind/"
echo "   üîå WebSocket: ws://localhost:5280/xmpp-websocket"

echo ""
echo -e "${BLUE}üõ†Ô∏è  Comandos √∫tiles:${NC}"
echo "   üìã Ver logs: docker compose logs -f"
echo "   üõë Detener: docker compose down"
echo "   üîÑ Reiniciar: docker compose restart"
echo "   üß™ Tests: ./run-tests.sh"
echo "   üîç Tests espec√≠ficos: $PYTHON_CMD -m pytest tests/test_web.py -v -s"
echo "   üê≥ Entrar a contenedor: docker exec -it jitsi-web bash"

echo ""
echo -e "${BLUE}üìä Estad√≠sticas de tests:${NC}"
if [ -f "test-results/junit.xml" ]; then
    echo "   üìÑ Reporte XML: test-results/junit.xml"
fi
if [ -f "test-results/report.html" ]; then
    echo "   üåê Reporte HTML: test-results/report.html"
fi

# Mostrar informaci√≥n de configuraci√≥n
echo ""
echo -e "${BLUE}‚öôÔ∏è  Configuraci√≥n actual:${NC}"
echo "   üìÅ Directorio: $(pwd)"
echo "   üêç Python: $($PYTHON_CMD --version 2>/dev/null || echo 'No encontrado')"
echo "   üê≥ Docker: $(docker --version 2>/dev/null || echo 'No encontrado')"
echo "   üì¶ Docker Compose: $(docker compose version 2>/dev/null || echo 'No encontrado')"
if [ -n "$VIRTUAL_ENV" ]; then
    echo "   üîß Entorno virtual: $VIRTUAL_ENV"
    echo "   üì¶ Paquetes instalados: $(pip list --format=freeze | wc -l) paquetes"
fi

print_status "SUCCESS" "Limpieza y test completados"
echo ""
if [ "$TEST_RESULT" = "SUCCESS" ]; then
    echo -e "${GREEN}üéâ ¬°Jitsi Meet est√° listo para usar!${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Revisar configuraci√≥n y logs para resolver problemas${NC}"
fi
